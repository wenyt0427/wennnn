<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂΩ±ÁâáËΩâ MP3 Â∑•ÂÖ∑</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-image: url('https://tinyurl.com/2yloljgu');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            width: 350px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        #fileInput {
            display: none;
        }
        .input-group {
            margin-bottom: 15px;
            position: relative;
        }
        label, button, select, input[type="text"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        label, button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
        }
        label:hover, button:hover {
            background-color: #2980b9;
        }
        select, input[type="text"] {
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        #status {
            margin-top: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
        #progressContainer {
            width: 100%;
            background-color: #ecf0f1;
            margin-top: 20px;
            border-radius: 5px;
            overflow: hidden;
            display: none;
        }
        #progressBar {
            width: 0%;
            height: 30px;
            background-color: #2ecc71;
            text-align: center;
            line-height: 30px;
            color: white;
            transition: width 0.3s ease;
        }
        #conversionStatus {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        #cancelBtn {
            width: 30px;
            height: 30px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
            display: none;
            line-height: 30px;
            padding: 0;
        }
        #cancelBtn:hover {
            background-color: #c0392b;
        }
        #downloadBtn, #reconvertBtn {
            display: none;
            background-color: #27ae60;
        }
        #downloadBtn:hover, #reconvertBtn:hover {
            background-color: #2ecc71;
        }
        #homeButton {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        #homeButton:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }
        .file-name {
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <button id="homeButton" onclick="window.location.href='https://wenyt0427.github.io/wennnn/%E7%B6%B2%E9%A0%81%E5%B7%A5%E5%85%B7/%E4%B8%BB%E9%A0%81%E9%9D%A2'">üè†</button>
    <div class="container">
        <h1>ÂΩ±ÁâáËΩâ MP3 Â∑•ÂÖ∑</h1>
        <div class="input-group">
            <input type="file" id="fileInput" accept="video/mp4,video/quicktime">
            <label for="fileInput">ÈÅ∏Êìá MP4 Êàñ MOV Êñá‰ª∂</label>
            <div id="fileName" class="file-name"></div>
        </div>
        <div class="input-group">
            <select id="quality">
                <option value="128">128 kbps</option>
                <option value="192">192 kbps</option>
                <option value="256">256 kbps</option>
                <option value="320">320 kbps</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="fileNameInput" placeholder="Ëº∏ÂÖ•Ê™îÊ°àÂêçÁ®± (ÂèØÈÅ∏)">
        </div>
        <div class="input-group">
            <button id="downloadBtn">‰∏ãËºâ MP3</button>
        </div>
        <div class="input-group">
            <button id="reconvertBtn">ÈáçÊñ∞ËΩâÊèõ</button>
        </div>
        <p id="status">Ë´ãÈÅ∏Êìá‰∏ÄÂÄã MP4 Êàñ MOV Êñá‰ª∂</p>
        <div id="progressContainer">
            <div id="progressBar">0%</div>
        </div>
        <div id="conversionStatus">
            <span id="conversionText"></span>
            <button id="cancelBtn">X</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const reconvertBtn = document.getElementById('reconvertBtn');
        const qualitySelect = document.getElementById('quality');
        const fileNameInput = document.getElementById('fileNameInput');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const fileName = document.getElementById('fileName');
        const cancelBtn = document.getElementById('cancelBtn');
        const conversionText = document.getElementById('conversionText');
        const conversionStatus = document.getElementById('conversionStatus');

        let selectedFile = null;
        let convertedBlob = null;
        let isConverting = false;
        let conversionCancelled = false;
        let currentConversionId = 0;
        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100 MB

        fileInput.addEventListener('change', (e) => {
            if (isConverting) {
                cancelConversion();
            }
            selectedFile = e.target.files[0];
            if (selectedFile.size > MAX_FILE_SIZE) {
                status.textContent = 'Êñá‰ª∂Â§™Â§ßÔºåË´ãÈÅ∏ÊìáÂ∞èÊñº 100MB ÁöÑÊñá‰ª∂';
            } else if (!selectedFile.type.startsWith('video/')) {
                status.textContent = 'Ë´ãÈÅ∏ÊìáÊúâÊïàÁöÑ MP4 Êàñ MOV Êñá‰ª∂';
            } else {
                fileName.textContent = selectedFile.name;
                fileNameInput.value = selectedFile.name.replace(/\.(mp4|mov)$/i, '');
                status.textContent = 'Êñá‰ª∂Â∑≤‰∏äÂÇ≥ÔºåÊ∫ñÂÇôËΩâÊèõ...';
                startConversion();
            }
        });

        cancelBtn.addEventListener('click', cancelConversion);

        downloadBtn.addEventListener('click', () => {
            if (!convertedBlob) return;

            const fileName = fileNameInput.value.trim() || 'converted';
            const url = URL.createObjectURL(convertedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.mp3`;
            a.click();
            URL.revokeObjectURL(url);
        });

        reconvertBtn.addEventListener('click', () => {
            if (selectedFile) {
                startConversion();
            }
        });

        function cancelConversion() {
            conversionCancelled = true;
            isConverting = false;
            status.textContent = 'ËΩâÊèõÂ∑≤ÂèñÊ∂à';
            progressContainer.style.display = 'none';
            conversionStatus.style.display = 'none';
            reconvertBtn.style.display = 'block';
            resetProgress();
        }

        function resetProgress() {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }

        async function startConversion() {
            if (!selectedFile) return;

            currentConversionId++;
            const thisConversionId = currentConversionId;

            conversionText.textContent = 'Ê≠£Âú®ËΩâÊèõ...';
            progressContainer.style.display = 'block';
            conversionStatus.style.display = 'flex';
            cancelBtn.style.display = 'block';
            downloadBtn.style.display = 'none';
            reconvertBtn.style.display = 'none';
            isConverting = true;
            conversionCancelled = false;
            resetProgress();

            try {
                const audioBuffer = await extractAudio(selectedFile);
                if (conversionCancelled || thisConversionId !== currentConversionId) return;
                convertedBlob = await encodeMp3(audioBuffer, parseInt(qualitySelect.value), thisConversionId);
                if (conversionCancelled || thisConversionId !== currentConversionId) return;
                
                status.textContent = 'ËΩâÊèõÂÆåÊàêÔºÅÈªûÊìä‰∏ãËºâÊåâÈàï‰ª•‰øùÂ≠òÊñá‰ª∂„ÄÇ';
                downloadBtn.style.display = 'block';
            } catch (error) {
                console.error('ËΩâÊèõÈåØË™§:', error);
                if (error.message === 'Conversion cancelled') {
                    status.textContent = 'ËΩâÊèõÂ∑≤ÂèñÊ∂à';
                } else {
                    status.textContent = `ËΩâÊèõÂ§±Êïó: ${error.message}`;
                }
                reconvertBtn.style.display = 'block';
            } finally {
                if (thisConversionId === currentConversionId) {
                    isConverting = false;
                    progressContainer.style.display = 'none';
                    conversionStatus.style.display = 'none';
                }
            }
        }

        async function extractAudio(file) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await file.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        }

        async function encodeMp3(audioBuffer, kbps, conversionId) {
            const sampleRate = audioBuffer.sampleRate;
            const samples = audioBuffer.getChannelData(0);
            const mp3encoder = new lamejs.Mp3Encoder(1, sampleRate, kbps);
            const mp3Data = [];

            const sampleBlockSize = 1152;
            const totalSamples = samples.length;
            
            for (let i = 0; i < totalSamples; i += sampleBlockSize) {
                if (conversionCancelled || conversionId !== currentConversionId) throw new Error('Conversion cancelled');
                const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                const int16SampleChunk = convertFloat32ToInt16(sampleChunk);
                const mp3buf = mp3encoder.encodeBuffer(int16SampleChunk);
                if (mp3buf.length > 0) {
                    mp3Data.push(new Int8Array(mp3buf));
                }
                updateProgress(i / totalSamples);
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            const mp3buf = mp3encoder.flush();
            if (mp3buf.length > 0) {
                mp3Data.push(new Int8Array(mp3buf));
            }
            
            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        function convertFloat32ToInt16(float32Array) {
            const int16Array = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return int16Array;
        }

        function updateProgress(ratio) {
            const percent = Math.round(ratio * 100);
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
        }
    </script>
</body>
</html>
