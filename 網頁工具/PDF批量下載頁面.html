<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF批量下載頁面</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- 載入 JSZip (用於壓縮檔案) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 預覽畫布的樣式 */
        .preview-canvas {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 100%;
            height: auto;
        }
        /* 載入中的動畫 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-5xl p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">PDF批量下載頁面</h1>
        
        <!-- 步驟一：上傳 -->
        <div class="mb-6">
            <label for="pdfInput" class="block mb-2 text-lg font-medium text-gray-700">1. 上傳 PDF 檔案</label>
            <input type="file" id="pdfInput" accept="application/pdf" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>

        <!-- 步驟二：設定 -->
        <div id="controls" class="mb-6 hidden">
            <label for="formatSelect" class="block mb-2 text-lg font-medium text-gray-700">2. 選擇圖片格式</label>
            <select id="formatSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-1/3 p-2.5">
                <option value="image/png">PNG (無損, 檔案較大)</option>
                <option value="image/jpeg">JPG (高品質, 檔案較小)</option>
            </select>
        </div>

        <!-- 步驟三：預覽與下載 -->
        <div id="downloadSection" class="mb-6 hidden">
            <h2 class="text-lg font-medium text-gray-700 mb-2">3. 勾選頁面並下載</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="downloadSelected" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    下載選定頁面
                </button>
                <button id="downloadAll" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    下載全部頁面
                </button>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-500">
                <input type="checkbox" id="selectAll" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                <label for="selectAll" class="cursor-pointer">全選 / 取消全選</label>
            </div>
        </div>

        <!-- 狀態顯示 -->
        <div id="status" class="text-center p-4 hidden">
            <div class="loader mx-auto"></div>
            <p id="statusText" class="text-lg font-medium text-gray-600 mt-4">載入中...</p>
        </div>

        <!-- 預覽區域 -->
        <div id="previewArea" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 bg-gray-50 p-6 rounded-lg border border-gray-200" style="max-height: 600px; overflow-y: auto;">
            <!-- 頁面預覽將會動態插入到這裡 -->
        </div>

    </div>

    <script>
        // 設定 PDF.js Worker 的路徑
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const pdfInput = document.getElementById('pdfInput');
        const previewArea = document.getElementById('previewArea');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        
        const controls = document.getElementById('controls');
        const downloadSection = document.getElementById('downloadSection');
        const formatSelect = document.getElementById('formatSelect');
        
        const downloadSelected = document.getElementById('downloadSelected');
        const downloadAll = document.getElementById('downloadAll');
        const selectAll = document.getElementById('selectAll');

        let pdfDoc = null;
        let totalPages = 0;
        let pdfFileName = ''; // 儲存上傳的檔案名稱
        const HIGH_QUALITY_SCALE = 3.0; // 決定輸出圖片的解析度 (3.0 約等於 216 DPI)
        const PREVIEW_SCALE = 0.5; // 預覽圖的解析度

        pdfInput.addEventListener('change', handleFileSelect);
        downloadSelected.addEventListener('click', downloadSelectedPages);
        downloadAll.addEventListener('click', downloadAllPages);
        selectAll.addEventListener('change', toggleSelectAll);

        /**
         * 處理檔案上傳
         */
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                return;
            }

            // 重置
            resetUI();
            // 儲存檔案名稱 (不含 .pdf)
            pdfFileName = file.name.replace(/\.pdf$/i, '');
            showStatus('正在載入 PDF...');

            try {
                const fileReader = new FileReader();
                fileReader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    const loadingTask = pdfjsLib.getDocument({ data: typedarray });
                    pdfDoc = await loadingTask.promise;
                    totalPages = pdfDoc.numPages;
                    
                    showStatus(`正在產生 ${totalPages} 頁預覽...`);
                    
                    const renderPromises = [];
                    for (let i = 1; i <= totalPages; i++) {
                        renderPromises.push(renderPagePreview(i));
                    }
                    
                    await Promise.all(renderPromises);
                    
                    hideStatus();
                    controls.classList.remove('hidden');
                    downloadSection.classList.remove('hidden');
                    downloadSelected.disabled = false;
                    downloadAll.disabled = false;
                };
                fileReader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('處理 PDF 時出錯:', error);
                showStatus('載入 PDF 失敗。', true);
            }
        }

        /**
         * 產生單頁預覽圖 (低解析度)
         */
        async function renderPagePreview(pageNum) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: PREVIEW_SCALE });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.className = 'preview-canvas';

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                await page.render(renderContext).promise;

                // 建立預覽項目
                const item = document.createElement('div');
                item.className = 'flex flex-col items-center gap-2 p-2 rounded-lg hover:bg-gray-200';
                
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'flex items-center gap-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'page-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500';
                checkbox.value = pageNum;
                checkbox.id = `check-${pageNum}`;
                
                const label = document.createElement('label');
                label.htmlFor = `check-${pageNum}`;
                label.textContent = `第 ${pageNum} 頁`;
                label.className = 'text-sm font-medium text-gray-700 cursor-pointer';
                
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                
                item.appendChild(canvas);
                item.appendChild(checkboxContainer);
                previewArea.appendChild(item);

            } catch (err) {
                console.error(`渲染預覽頁 ${pageNum} 失敗:`, err);
                // 即使單頁失敗也繼續
            }
        }

        /**
         * 下載選定的頁面
         */
        function downloadSelectedPages() {
            const selectedCheckboxes = document.querySelectorAll('.page-checkbox:checked');
            const pageNumbers = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            if (pageNumbers.length === 0) {
                showStatus('請至少選擇一個頁面。', true, 2000);
                return;
            }

            if (pageNumbers.length === 1) {
                downloadPageAsImage(pageNumbers[0]);
            } else {
                downloadPagesAsZip(pageNumbers);
            }
        }

        /**
         * 下載所有頁面
         */
        function downloadAllPages() {
            const pageNumbers = Array.from({ length: totalPages }, (_, i) => i + 1);
            
            if (pageNumbers.length === 1) {
                downloadPageAsImage(pageNumbers[0]);
            } else {
                downloadPagesAsZip(pageNumbers);
            }
        }

        /**
         * 將多個頁面打包下載為 Zip
         */
        async function downloadPagesAsZip(pageNumbers) {
            showStatus(`正在壓縮 ${pageNumbers.length} 個檔案...`);
            const zip = new JSZip();
            const format = formatSelect.value;
            const extension = format === 'image/png' ? '.png' : '.jpg';
            const folderName = pdfFileName || "PDF_Images"; // 使用 PDF 檔案名稱作為資料夾名稱

            try {
                for (const pageNum of pageNumbers) {
                    statusText.textContent = `正在處理第 ${pageNum} 頁... (共 ${pageNumbers.length} 頁)`;
                    const [dataUrl, imgFileName] = await generateHighQualityImage(pageNum, format);
                    // 從 data URL 中提取 base64 數據
                    const base64Data = dataUrl.split(',')[1];
                    // 將檔案添加到資料夾中
                    zip.file(`${folderName}/${imgFileName}`, base64Data, { base64: true });
                }

                showStatus('正在產生 Zip 檔案...');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                const zipFileName = `${pdfFileName || 'PDF_Pages'}.zip`; // 使用 PDF 檔案名稱作為 Zip 檔案名稱
                triggerDownload(URL.createObjectURL(zipBlob), zipFileName);
                hideStatus();

            } catch (error) {
                console.error('壓縮檔案時出錯:', error);
                showStatus('壓縮失敗。', true);
            }
        }

        /**
         * 下載單一頁面為圖片
         */
        async function downloadPageAsImage(pageNum) {
            showStatus(`正在產生第 ${pageNum} 頁...`);
            const format = formatSelect.value;
            
            try {
                const [dataUrl, fileName] = await generateHighQualityImage(pageNum, format);
                triggerDownload(dataUrl, fileName);
                hideStatus();
            } catch (error) {
                console.error('產生圖片時出錯:', error);
                showStatus('產生圖片失敗。', true);
            }
        }

        /**
         * 產生高解析度的單頁圖片 Data URL
         */
        async function generateHighQualityImage(pageNum, format) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: HIGH_QUALITY_SCALE });
            
            // 建立一個隱藏的 canvas 來進行高解析度渲染
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            const extension = format === 'image/png' ? '.png' : '.jpg';
            const fileName = `${pdfFileName || 'Page'}_${pageNum}${extension}`; // 使用 PDF 檔案名稱命名圖片
            
            // 對於 JPG 格式，使用最高品質 (1.0)
            const dataUrl = canvas.toDataURL(format, 1.0);
            
            return [dataUrl, fileName];
        }

        /**
        * 觸發瀏覽器下載
        */
        function triggerDownload(url, fileName) {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // 釋放 object URL (如果是 blob)
            if (url.startsWith('blob:')) {
                URL.revokeObjectURL(url);
            }
        }

        /**
         * 全選/取消全選
         */
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.page-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        /**
         * 重置介面
         */
        function resetUI() {
            previewArea.innerHTML = '';
            controls.classList.add('hidden');
            downloadSection.classList.add('hidden');
            downloadSelected.disabled = true;
            downloadAll.disabled = true;
            selectAll.checked = false;
            pdfDoc = null;
            totalPages = 0;
            pdfFileName = ''; // 重置檔案名稱
            hideStatus();
        }

        function showStatus(message, isError = false, autoHideDelay = 0) {
            statusText.textContent = message;
            statusText.className = isError 
                ? 'text-lg font-medium text-red-600 mt-4' 
                : 'text-lg font-medium text-gray-600 mt-4';
            status.classList.remove('hidden');

            if (autoHideDelay > 0) {
                setTimeout(hideStatus, autoHideDelay);
            }
        }

        function hideStatus() {
            status.classList.add('hidden');
        }

    </script>
</body>
</html>



